# Peertube helm chart
## install
1. `helm deps build`
2. `helm upgrade --install -n <namespace> <release name> ./chart -f values.yaml`
3. run `helm upgrade --install -n <namespace> <release name> ./chart -f values.yaml` again - see: DB vs peertube race condition during install
4. finally configure peertube

## chart config
`sample.yaml` contain a sample configuration for an mw kubernetes cluster. There are a lot more available options, but you probably only need the ones in `sample.yaml`. All available options can be found `chart/values.yaml`. `minimal-sample.yaml` is a minimal configuration for an production deployment on mw kubernetes.


## pertube config
### imprint and privacy policy
Peertube dose not have a dedicate section for privacy policy and imprint. There is also no mechanism to get the consent of a user to the privacy policy.

Peertube has a about page. You could put your privacy policy into the terms section and your imprint into the server description. Both of them can be configured under admin/config/edit-custom#instance-information. All the way at the bottom of the page is an `Update configuration` button which you need to press.


### get admin **password**
1. `kubectl exec -it -n <namespace> deployments/<release name> -- npm run reset-password -- -u root`
2. enter a new password
3. now you can login as `root`

### openID connect
1. go to /admin/plugins/search
2. search for `auth-openid-connect` and install it
3. configure open id connect the callback path is `/plugins/auth-openid-connect/router/code-cb`
4. (optionally) go to `/admin/config/edit-custom#basic-configuration` and enable `Redirect users on single external auth when users click on the login button in menu`. At the bottom of the page, click `Update configuration`. (Before an openid connect user should be made admin)
#### with gitlab
1. register a new oauth application in gitlab: The redirected url is `https://<peertube hostname>/plugins/auth-openid-connect/router/code-cb`. Enable the following scopes: `openid`, `profile`, `email`.
2. configure peertube: `Client ID` and `Client secret` are generated by gitlab. The `Username property` needs to be set to `nickname`.

### p2p
Peertube users can share videos with p2p, to reduce load on the server. This is disabled by default. As it requires peertube to share technical information about users e.g. their ip addresses with other users. Which probably is not GDPR compliant. (Users are still able to activate p2p in there settings. "Help share videos being played")

It can be disable by setting peertube.config.defaults.p2p.webapp to true in the peertube values.yaml. (Peertube.config is a string containing a yaml config. Modifying defaults.p2p.webapp requires to copy the whole peertube.config option to your values.yaml and then changing .defaults.p2p.webapp.)


## Caveats / Problems
### Websockets do not work all the time.
Sometimes websocktes work sometimes they fail. Maybe this is a problem with 2 nginx containers?

(Websockets are use to share p2p information, which is disable by default in this chart.)

### Static files get served by node
The default nginx config serves static files. This is no possible with nginx ingress on its own.
It would be possible to spin up a nginx container to serve static files. But that would require shared storage.

### No peertube-runner
PeerTube supports VOD or Live transcoding by a remote PeerTube runner. PeerTube runners currently are not supported

### DB vs peertube race condition during install
If the db is not ready before peertube starts for the first time, installation will fail and the database will be corrupted.

If peertube start before the db is ready, it will time out and restart the container. Also if the db becomes awaitable during waiting.
The second run will fail with a corrupted db. Probably some files are created in persistent storage during the first run. Which may causes the second run to be an update an not an install. But this is only a guess i did not look in to it.

As a work around there is an init pod, which waits for the db to be ready. And should sleeps for 10s. The init pod is only created if the chart is installed and `postgresWait.enabled=ture` (which is the default). The first helm upgrade will remove the init pod. Therefore you should run helm upgrade after the installation has finished.
